{% extends "base.html" %}
{% load static %}
{% block content %}

<div class="p-6 space-y-6 pb-28 md:pb-6">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    {# -- Profile card ------------------------------------------------------ #}
    <div class="bg-teal-500 text-white rounded-3xl p-8 lg:p-10 flex flex-col items-center text-center shadow-sm">
      <div class="w-44 h-44 rounded-full bg-white grid place-items-center">
        <img
          src="{% if clinician.avatar %}{{ clinician.avatar.url }}?v={{ clinician.avatar.size }}{% else %}{% static 'img/avatar-doc.png' %}{% endif %}"
          alt="Avatar"
          class="w-40 h-40 object-cover rounded-full"
        >
      </div>

      <a
  href="{% url 'clinicians_ui:edit_profile' clinician.pk %}"
  class="mt-3 inline-block text-emerald-900/90 bg-white/90 hover:bg-white px-4 py-1.5 rounded-full text-sm font-medium">
  edit
</a>


      <div class="text-4xl font-extrabold tracking-tight mt-6">
        Dr {{ clinician.get_full_name|default:clinician.username|title }}
      </div>
    </div>

    {# -- Consultations (stable container + HTMX body) ---------------------- #}
    <div class="lg:col-span-2">
      <div class="bg-white rounded-2xl p-4 ring-1 ring-black/5 h-full min-h-[360px] flex flex-col consultation-shell">
        <div class="flex items-center justify-between mb-3">
          <div class=" hidden sm:block text-lg font-semibold">Consultation</div>
          <div class="text-xs text-gray-500">Next 48h</div>
           <div class="flex items-center justify-between gap-3 mb-3">
       <div class="flex items-center gap-2">
        <a href="{% url 'clinicians_ui:consultations_all' clinician.pk %}"
           class="inline-flex items-center rounded-xl bg-gray-200/70 px-3 py-1.5 text-sm font-medium text-gray-800">
          See all
        </a>
        <a href="{% url 'appointments_ui:console_new_appointment' %}?clinician={{ clinician.pk }}"
           class="inline-flex items-center gap-2 rounded-xl bg-gray-100 px-3 py-1.5 text-sm font-medium text-gray-900">
          Create <span class="grid h-5 w-5 place-items-center rounded-full bg-emerald-600 text-white">+</span>
        </a>
      </div>
    </div>
        </div>

        <div id="upcoming-body"
             class="flex-1"
             hx-get="{% url 'clinicians_ui:upcoming' clinician.pk %}"
             hx-trigger="load, every 30s"
             hx-swap="innerHTML">
          <div class="text-gray-400 text-sm">Loadingâ€¦</div>
        </div>
      </div>
    </div>

    {# -- Tests -------------------------------------------------------------- #}
    <div class="bg-white rounded-2xl p-4 ring-1 ring-black/5">
      <div class="text-center font-semibold mb-2">Test</div>
      <div id="tests"
           hx-get="{% url 'clinicians_ui:tests' clinician.pk %}"
           hx-trigger="load, every 60s"
           hx-swap="innerHTML">
        <div class="text-gray-400 text-sm">Loadingâ€¦</div>
      </div>
    </div>

    {# -- Shortcuts (desktop/tablet panel) ---------------------------------- #}
    <div class="bg-white rounded-2xl p-4 ring-1 ring-black/5 space-y-4 hidden md:block">
      <div class="grid grid-cols-2 gap-4">
        {% for s in shortcuts %}
          <a href="{{ s.href }}" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-gray-50 hover:bg-gray-100">
            <div class="shortcut-circle relative">
              <img src="{% static 'img/shortcuts/'|add:s.icon %}" alt="{{ s.label }}"
                   class="{% if s.accent == 'red' %}opacity-90{% endif %}"
                   onerror="this.style.display='none'; this.parentElement.querySelector('[data-fb]').style.display='grid';">
              <div data-fb class="hidden absolute inset-0 place-items-center text-3xl">
                {% if s.accent == 'red' %}ðŸš¨{% else %}ðŸ©º{% endif %}
              </div>
            </div>
            <div class="text-base font-semibold">{{ s.label }}</div>
          </a>
        {% endfor %}
      </div>
    </div>

    {# -- Inbox / DM --------------------------------------------------------- #}
    <div class="lg:col-span-3 bg-white rounded-2xl p-0 ring-1 ring-black/5">
      <div class="flex border-b">
        <button class="px-4 py-2 font-medium"
                hx-get="{% url 'clinicians_ui:inbox' clinician.pk %}"
                hx-target="#mail"
                hx-swap="innerHTML">Inbox</button>
        <button class="px-4 py-2 text-gray-500"
                hx-get="{% url 'clinicians_ui:direct_messages' clinician.pk %}"
                hx-target="#mail"
                hx-swap="innerHTML">Direct Message</button>
      </div>
      <div id="mail" class="p-4"
           hx-get="{% url 'clinicians_ui:inbox' clinician.pk %}"
           hx-trigger="load"
           hx-swap="innerHTML">
        <div class="text-gray-400 text-sm p-2">Loadingâ€¦</div>
      </div>
    </div>

  </div>
</div>

{# ------------------------- Mobile dock ----------------------------------- #}
<div class="mobile-dock md:hidden">
  <div class="mobile-dock__row">
    <a href="{{ primary_shortcuts.0.href }}" class="dock-btn">
      <span class="dock-btn__circle">
        <img src="{% static 'img/shortcuts/' %}{{ primary_shortcuts.0.icon }}" alt="" onerror="this.remove()">
      </span>
      <span class="dock-btn__label">{{ primary_shortcuts.0.label }}</span>
    </a>

    <button type="button" class="dock-btn dock-btn--primary" id="dock-open">
      <span class="dock-btn__circle">
        <svg viewBox="0 0 24 24" class="w-8 h-8" fill="currentColor" aria-hidden="true">
          <circle cx="8" cy="8" r="3"></circle>
          <circle cx="16" cy="8" r="3"></circle>
          <circle cx="8" cy="16" r="3"></circle>
          <circle cx="16" cy="16" r="3"></circle>
        </svg>
      </span>
      <span class="dock-btn__label">More</span>
    </button>

    <a href="{{ primary_shortcuts.1.href }}" class="dock-btn">
      <span class="dock-btn__circle">
        <img src="{% static 'img/shortcuts/' %}{{ primary_shortcuts.1.icon }}" alt="" onerror="this.remove()">
      </span>
      <span class="dock-btn__label">{{ primary_shortcuts.1.label }}</span>
    </a>
  </div>
</div>

<div id="offcanvas" class="offcanvas md:hidden" aria-hidden="true">
  <div class="offcanvas__mask" id="oc-mask"></div>
  <div class="offcanvas__panel" role="dialog" aria-modal="true" aria-label="Quick actions">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold">Menu</div>
      <button type="button" id="dock-close" class="btn">âœ•</button>
    </div>

    <div class="offcanvas__list">
      {% for s in more_shortcuts %}
        <a href="{{ s.href }}" class="offcanvas__item">
          <span class="offcanvas__circle {% if s.accent == 'red' %}bg-red-500 text-white border-transparent{% endif %}">
            <img src="{% static 'img/shortcuts/' %}{{ s.icon }}" alt="" onerror="this.remove()">
          </span>
          <span class="offcanvas__label">{{ s.label }}</span>
        </a>
      {% endfor %}
    </div>
  </div>
</div>

<script>
  const ocRoot   = document.getElementById('offcanvas');
  const ocMask   = document.getElementById('oc-mask');
  const openBtn  = document.getElementById('dock-open');
  const closeBtn = document.getElementById('dock-close');

  function openOC(){
    ocRoot.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  }
  function closeOC(){
    ocRoot.classList.remove('is-open');
    document.body.style.overflow = '';
  }

  openBtn?.addEventListener('click', openOC);
  closeBtn?.addEventListener('click', closeOC);
  ocMask?.addEventListener('click', closeOC);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeOC(); });
</script>

{% endblock %}
