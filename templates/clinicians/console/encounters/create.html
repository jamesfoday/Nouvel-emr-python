{% extends "base.html" %}
{% block content %}
<div class="mx-auto mt-6 w-full max-w-5xl px-3 sm:px-6">
  <!-- Glassy shell -->
  <div class="rounded-3xl bg-[#CFE8D6]/70 p-1">
    <div class="rounded-3xl bg-white/70 backdrop-blur p-5 sm:p-7 shadow-xl">

      <!-- Top bar: centered title, Back on the right (Create page doesn't need a left CTA) -->
      <div class="mb-4 flex items-center justify-between">
        <div class="w-28"></div>
        <h1 class="text-lg sm:text-xl font-semibold text-gray-800">Create Encounter</h1>
        <a href="{% url 'encounters_ui:list' pk=clinician.pk %}"
           class="inline-flex items-center gap-2 rounded-full bg-gray-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:brightness-95">
          Back
        </a>
      </div>

      <!-- Card body -->
      <div class="rounded-3xl bg-[#EEF7F0] p-4 sm:p-6 ring-1 ring-black/5">
        {% if error %}
          <div class="mb-4 rounded-xl border border-red-200 bg-red-50 px-3 py-2 text-sm text-red-700">
            {{ error }}
          </div>
        {% endif %}

        <form method="post" class="space-y-6">
          {% csrf_token %}

          <!-- Patient picker (HTMX) -->
          <div>
            <label class="block text-gray-800 font-semibold mb-2">Patient</label>
            <div class="relative">
              <input
                type="text"
                name="patient_query"
                placeholder="Search patient"
                class="w-full rounded-full bg-white/80 ring-1 ring-gray-200 px-4 py-2.5 pr-10 text-sm text-gray-800 focus:outline-none focus:ring-2 focus:ring-emerald-300"
                hx-get="{% url 'patients_ui:pick_list' %}"
                hx-params="*"
                hx-target="#patient-results"
                hx-trigger="input changed delay:300ms"
                autocomplete="off">
              <svg class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none">
                <path d="M21 21l-4.3-4.3m1.3-5.2a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z" stroke="currentColor" stroke-width="2"/>
              </svg>
            </div>
            <input type="hidden" name="patient_id" id="patient_id">
            <div id="patient-results" class="mt-3 max-h-64 overflow-auto rounded-2xl bg-white/80 ring-1 ring-gray-200"></div>
            <p class="mt-2 text-sm text-gray-600">
              Need a new patient?
              <a href="{% url 'patients_ui:patients_home' %}" class="text-emerald-700 underline">Open patients</a>
            </p>
          </div>

          <!-- Optional meta -->
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-800 font-semibold mb-2">Reason (optional)</label>
              <input type="text" name="reason"
                     class="w-full rounded-xl bg-white/80 ring-1 ring-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-300"
                     placeholder="Reason for visit">
            </div>
            <div>
              <label class="block text-gray-800 font-semibold mb-2">Location (optional)</label>
              <input type="text" name="location"
                     class="w-full rounded-xl bg-white/80 ring-1 ring-gray-200 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-300"
                     placeholder="Room / Ward">
            </div>
          </div>

          <!-- Actions -->
          <div class="pt-2 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
            <a href="{% url 'encounters_ui:list' pk=clinician.pk %}"
               class="w-full sm:w-auto inline-flex items-center justify-center rounded-full bg-rose-600 px-6 py-2 text-sm font-semibold text-white shadow-sm hover:brightness-95">
              Cancel
            </a>
            <button
              class="w-full sm:w-auto inline-flex items-center justify-center rounded-full bg-emerald-600 px-6 py-2 text-sm font-semibold text-white shadow-sm hover:brightness-95">
              Create
            </button>
          </div>
        </form>
      </div>

    </div>
  </div>
</div>

<script>
  // Called by the pick list partial
  function selectPatient(id, label){
    document.getElementById('patient_id').value = id;
    const input = document.querySelector('input[name="patient_query"]');
    if (input) input.value = label;
  }

  // Delegate clicks from HTMX-rendered results
  document.addEventListener('click', function (e) {
    const btn = e.target.closest('button.pick-patient');
    if (!btn) return;
    const id = btn.dataset.id;
    const label = btn.dataset.label || '';
    if (window.selectPatient) window.selectPatient(id, label);
    const box = document.getElementById('patient-results');
    if (box) box.innerHTML = '';
  });
</script>
{% endblock %}
