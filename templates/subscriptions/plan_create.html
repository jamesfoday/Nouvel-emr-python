{% extends "base.html" %}
{% block content %}
<div class="p-6 md:p-8">
  <div class="mx-auto max-w-3xl space-y-6">

    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold text-emerald-900">Create Plan</h1>
      <a href="{% url 'subscriptions:plans' %}"
         class="rounded-full px-4 py-2 text-sm bg-white/80 ring-1 ring-emerald-900/10 hover:bg-white">
        Back to Plans
      </a>
    </div>

    <form method="post"
          class="rounded-3xl bg-white/55 supports-[backdrop-filter]:bg-white/35 backdrop-blur-md ring-1 ring-emerald-900/10 shadow p-5 md:p-6 space-y-5">
      {% csrf_token %}

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Name</label>
          {{ form.name }}
          {% if form.name.errors %}<p class="text-sm text-red-600 mt-1">{{ form.name.errors|join:", " }}</p>{% endif %}
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Slug</label>
          {{ form.slug }}
          <p class="text-xs text-gray-500 mt-1">Auto-filled from the name; you can edit.</p>
          {% if form.slug.errors %}<p class="text-sm text-red-600 mt-1">{{ form.slug.errors|join:", " }}</p>{% endif %}
        </div>
      </div>

      <div>
        <label class="block text-sm font-semibold mb-1">Description</label>
        {{ form.description }}
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Interval</label>
          {{ form.interval }}
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Price</label>
          <div class="relative">
            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500">€</span>
            {# add padding-left without a custom filter #}
            {{ form.price }}
          </div>
          <p id="pricePreview" class="text-xs text-gray-500 mt-1">€0.00/month</p>
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Sort order</label>
          {{ form.sort_order }}
        </div>
      </div>

      <div class="grid md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-semibold mb-1">Max patients</label>
          {{ form.max_patients }}
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Max staff</label>
          {{ form.max_staff }}
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Storage (MB)</label>
          {{ form.storage_mb }}
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 items-end">
        <div>
          <label class="block text-sm font-semibold mb-1">Stripe Price ID (optional)</label>
          {{ form.stripe_price_id }}
          <p class="text-xs text-gray-500 mt-1">Use when wiring to Stripe (e.g., <code>price_...</code>).</p>
        </div>
        <label class="inline-flex items-center gap-2 mt-6 md:mt-0">
          {{ form.is_active }}
          <span class="text-sm">Active</span>
        </label>
      </div>

      <div class="flex items-center justify-end gap-3">
        <a href="{% url 'subscriptions:plans' %}"
           class="rounded-xl px-4 py-2 bg-white/80 ring-1 ring-emerald-900/10 hover:bg-white">Cancel</a>
        <button class="rounded-xl px-5 py-2 bg-emerald-600 text-white font-semibold hover:bg-emerald-700">
          Create Plan
        </button>
      </div>
    </form>
  </div>
</div>

{% block scripts %}
<script>
  (function () {
    // Auto-slug from name (only if slug untouched)
    const nameEl = document.getElementById("id_name");
    const slugEl = document.getElementById("id_slug");
    let slugDirty = false;
    slugEl?.addEventListener('input', () => slugDirty = true);
    nameEl?.addEventListener('input', () => {
      if (slugDirty || !slugEl) return;
      const s = nameEl.value.toLowerCase().trim()
        .replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
      slugEl.value = s;
    });

    // Price preview
    const priceEl = document.getElementById("id_price");
    const intEl   = document.getElementById("id_interval");
    const prev    = document.getElementById("pricePreview");
    function updatePreview(){
      if (!prev) return;
      const v = Number(priceEl?.value || 0).toFixed(2);
      const it = intEl?.value || "month";
      prev.textContent = `€${v}/${it}`;
    }
    priceEl?.addEventListener('input', updatePreview);
    intEl?.addEventListener('change', updatePreview);
    updatePreview();

    // Add Tailwind-like classes to Django widgets (no custom filter needed)
    const inputs = [
      "id_name","id_slug","id_description","id_interval","id_price","id_sort_order",
      "id_max_patients","id_max_staff","id_storage_mb","id_stripe_price_id"
    ].map(id => document.getElementById(id)).filter(Boolean);
    inputs.forEach(el => {
      el.classList.add("w-full","rounded-xl","px-3","py-2","ring-1","ring-gray-200","focus:ring-emerald-500","outline-none");
    });
    // Add extra left padding to price (because of € icon)
    document.getElementById("id_price")?.classList.add("pl-8");
  })();
</script>
{% endblock %}
{% endblock %}
