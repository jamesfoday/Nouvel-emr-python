<div class="fixed inset-0 z-50">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/30" onclick="document.getElementById('modal-root').innerHTML=''"></div>

  <!-- Modal -->
  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="w-full max-w-2xl rounded-2xl border border-white/30 bg-white/95 shadow-2xl backdrop-blur p-5">
      <div class="flex items-center justify-between">
        <h2 class="text-lg font-semibold text-gray-900">Diagnostic Report</h2>
        <button class="rounded-lg bg-gray-900/90 px-2 py-1 text-xs font-semibold text-white"
                onclick="document.getElementById('modal-root').innerHTML=''">Close</button>
      </div>

      <div class="mt-3 grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm text-gray-800">
        <div><span class="font-medium">Performing lab:</span> {{ r.performing_lab|default:"—" }}</div>
        <div><span class="font-medium">Status:</span> {{ r.status|title }}</div>
        <div><span class="font-medium">Issued at:</span> {{ r.issued_at|date:"D, M j Y · H:i" }}</div>
        {% if r.pdf %}
          <div><a class="text-emerald-700 underline" href="{{ r.pdf.url }}" target="_blank">Download PDF</a></div>
        {% endif %}
      </div>

      {% if obs %}
        <div class="mt-5 overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-gray-500">
                <th class="text-left pr-2 py-1">Test</th>
                <th class="text-right px-2 py-1">Value</th>
                <th class="text-left px-2 py-1">Unit</th>
                <th class="text-left pl-2 py-1">Reference</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-emerald-100">
              {% for o in obs %}
                <tr>
                  <td class="pr-2 py-1">{{ o.name }}</td>
                  <td class="text-right px-2 py-1">
                    {% if o.value_num or o.value_num == 0 %}
                      {{ o.value_num }}
                    {% else %}
                      {{ o.value_text }}
                    {% endif %}
                    {% if o.flag %}
                      {% with f=o.flag|lower %}
                        {% if f == 'h' or f == 'high' or f == 'critical' %}
                          <span class="ml-1 text-xs text-red-600">({{ o.flag }})</span>
                        {% elif f == 'l' or f == 'low' %}
                          <span class="ml-1 text-xs text-amber-600">({{ o.flag }})</span>
                        {% else %}
                          <span class="ml-1 text-xs text-gray-500">({{ o.flag }})</span>
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  </td>
                  <td class="px-2 py-1">{{ o.unit }}</td>
                  <td class="pl-2 py-1">
                    {% if o.ref_low %}{{ o.ref_low }}{% endif %}
                    {% if o.ref_high %}– {{ o.ref_high }}{% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <p class="mt-5 text-sm text-gray-500">No observations listed.</p>
      {% endif %}

      <div class="mt-5 flex items-center justify-end">
        <button class="rounded-xl bg-emerald-600 px-3 py-1.5 text-sm font-semibold text-white hover:brightness-95"
                onclick="document.getElementById('modal-root').innerHTML=''">Done</button>
      </div>
    </div>
  </div>
</div>
