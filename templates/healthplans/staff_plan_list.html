{% extends "base.html" %}

{% block content %}
<div class="p-6 md:p-8 space-y-6 max-w-6xl mx-auto">
  <!-- Page header -->
 <div class="flex flex-wrap gap-2">
  <!-- Home -->
  <a href="{% url 'reception:dashboard' %}"
     class="inline-flex items-center gap-2 rounded-full bg-emerald-600 px-4 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
    <!-- tiny house icon -->
    <!-- <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M3 11l9-7 9 7M5 10v10a1 1 0 001 1h4m4 0h4a1 1 0 001-1V10"/>
    </svg> -->
    Home
  </a>

  <!-- Create Plan -->
  <a href="{% url 'healthplans:plan_create' %}"
     class="rounded-full bg-emerald-600 text-white px-4 py-2 text-sm font-semibold shadow hover:bg-emerald-700">
    + Create Plan
  </a>

  <!-- Enroll Patient -->
  <a href="{% url 'healthplans:staff_enroll_patient' %}"
     class="rounded-full bg-emerald-100 text-emerald-800 px-4 py-2 text-sm font-semibold hover:bg-emerald-200 ring-1 ring-emerald-200">
    Enroll Patient
  </a>
</div>


  <!-- Tabs -->
  <div class="w-full">
    <div class="flex gap-2 border-b border-emerald-900/10">
      <button
        id="tab-plans"
        class="tab-btn px-4 py-2 rounded-t-xl text-sm font-semibold aria-selected:bg-white aria-selected:text-emerald-900
               text-emerald-900/70 hover:text-emerald-900"
        role="tab"
        aria-selected="true"
        aria-controls="panel-plans"
        data-target="panel-plans"
      >
        Health Plans ‚Äî Admin
      </button>
      <button
        id="tab-subscribers"
        class="tab-btn px-4 py-2 rounded-t-xl text-sm font-semibold aria-selected:bg-white aria-selected:text-emerald-900
               text-emerald-900/70 hover:text-emerald-900"
        role="tab"
        aria-selected="false"
        aria-controls="panel-subscribers"
        data-target="panel-subscribers"
      >
        Subscribers
      </button>
    </div>

    <!-- Panels -->
    <div class="rounded-b-2xl rounded-tr-2xl ring-1 ring-emerald-900/10 bg-white/60 supports-[backdrop-filter]:bg-white/40 backdrop-blur p-5 mt-0">

      <!-- Plans panel -->
      <section id="panel-plans" role="tabpanel" aria-labelledby="tab-plans">
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-5">
          {% for p in plans %}
            <article class="rounded-3xl bg-white/55 supports-[backdrop-filter]:bg-white/35 backdrop-blur-md ring-1 ring-emerald-900/10 shadow hover:ring-emerald-900/20 transition flex flex-col">
              <div class="p-5 space-y-3 flex-1">
                <div class="text-lg font-semibold text-emerald-950">
                  {{ p.name }}
                  {% if not p.is_active %}
                    <span class="ml-2 text-xs rounded-full bg-gray-100 text-gray-700 px-2 py-0.5 align-middle">Archived</span>
                  {% endif %}
                </div>
                <div class="text-3xl font-bold text-emerald-800">{{ p.price_display }}</div>
                <ul class="mt-2 text-sm text-emerald-950/80 space-y-1">
                  <li>ü©∫ {{ p.visits_per_period }} visits / {{ p.interval }}</li>
                  {% if p.includes_telehealth %}<li>üì± Telehealth included</li>{% endif %}
                  <li>üí≥ Copay: {{ p.copay_display }}</li>
                  <li>üìâ Deductible: {{ p.deductible_display }}</li>
                  <li>üõ°Ô∏è OOP max: {{ p.oop_max_display }}</li>
                  {% if p.coinsurance_pct %}<li>ÔºÖ Coinsurance: {{ p.coinsurance_pct }}%</li>{% endif %}
                  {% if p.region %}<li>üåç Region: {{ p.region }}</li>{% endif %}
                </ul>
              </div>

              <div class="p-5 pt-0 flex gap-2 flex-wrap">
                <!-- Edit -->
                <a href="{% url 'healthplans:plan_update' p.slug %}"
                   class="flex-1 text-center rounded-full px-3 py-2 text-sm bg-white ring-1 ring-emerald-900/15 hover:bg-emerald-50">
                  Edit
                </a>

                <!-- Archive (soft delete) -->
                <form method="post" action="{% url 'healthplans:plan_archive' p.slug %}" class="flex-1">
                  {% csrf_token %}
                  <button class="w-full rounded-full px-3 py-2 text-sm bg-amber-50 text-amber-800 ring-1 ring-amber-200 hover:bg-amber-100">
                    {% if p.is_active %}Archive{% else %}Unarchive{% endif %}
                  </button>
                </form>

                <!-- Delete -->
                <form method="post" action="{% url 'healthplans:plan_delete' p.slug %}" class="w-full"
                      onsubmit="return confirm('Delete permanently? This cannot be undone.')">
                  {% csrf_token %}
                  <button class="w-full rounded-full px-3 py-2 text-sm bg-red-50 text-red-700 ring-1 ring-red-200 hover:bg-red-100">
                    Delete
                  </button>
                </form>
              </div>
            </article>
          {% empty %}
            <div class="col-span-full text-emerald-900/70">No plans yet.</div>
          {% endfor %}
        </div>
      </section>

     <!-- Subscribers panel (mint glass LIST) -->
<section id="panel-subscribers" class="hidden" role="tabpanel" aria-labelledby="tab-subscribers">
  <!-- Header + filter -->
  <div class="flex items-center justify-between mb-4 gap-3 flex-wrap">
    <h2 class="text-lg font-semibold text-emerald-900">Subscribers</h2>
    <form method="get" class="flex items-stretch gap-2">
      <input type="hidden" name="tab" value="subscribers" />
      <input
        type="text"
        name="q"
        value="{{ q }}"
        placeholder="Search by name / email‚Ä¶"
        class="rounded-full px-4 py-2 ring-1 ring-emerald-900/10 bg-emerald-50/60 focus:outline-none focus:ring-emerald-300 min-w-[260px]"
      />
      <button class="rounded-full px-4 py-2 bg-emerald-700 text-white text-sm font-semibold hover:bg-emerald-800">Apply</button>
      <a href="?tab=subscribers" class="rounded-full px-4 py-2 ring-1 ring-emerald-900/10 bg-white/70 text-emerald-900 text-sm">Reset</a>
    </form>
  </div>

  {% if enrollments %}
    <ul class="space-y-4">
      {% for en in enrollments %}
        <li class="relative rounded-[28px] bg-white supports-[backdrop-filter]:bg-emerald-50/60 backdrop-blur ring-1 ring-emerald-900/10 shadow-sm px-5 py-4">
          <!-- Status badge (top-right) -->
          <div class="absolute top-3 right-4">
            {% if en.status == 'active' %}
              <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-800 px-2.5 py-0.5 text-xs font-medium">Active</span>
            {% elif en.status == 'trialing' %}
              <span class="inline-flex items-center rounded-full bg-blue-100 text-blue-800 px-2.5 py-0.5 text-xs font-medium">Trialing</span>
            {% elif en.status == 'canceled' %}
              <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 px-2.5 py-0.5 text-xs font-medium">Canceled</span>
            {% else %}
              <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 px-2.5 py-0.5 text-xs font-medium">{{ en.status }}</span>
            {% endif %}
          </div>

          <!-- Main row -->
          <div class="flex items-start gap-3 pr-28">
            <!-- Avatar -->
            <div class="shrink-0 w-10 h-10 rounded-full grid place-items-center font-semibold ring-1 ring-emerald-900/10 bg-emerald-200/70 text-emerald-800">
              {{ en.user.first_name|default:en.user.username|first|upper }}
            </div>

            <!-- Text block -->
            <div class="flex-1 min-w-0">
              <!-- Name -->
              <div class="text-[15px] font-semibold text-emerald-950 truncate">
                {{ en.user.get_full_name|default:en.user.email|default:en.user.username }}
              </div>
              <!-- Subline: plan + period (like ‚Äúdate ‚Ä¢ online‚Äù) -->
              <div class="text-sm text-emerald-900/80">
                {{ en.plan.name }} ‚Ä¢ {{ en.plan.price_display }}
              </div>
              <div class="text-sm text-emerald-900/80">
                {{ en.current_period_start|date:"D, M d Y" }} ‚Ä¢ {{ en.current_period_end|date:"M d Y" }}
              </div>

              <!-- Cancel/resume flag row -->
              <div class="mt-2">
                {% if en.cancel_at_period_end %}
                  <span class="inline-flex items-center rounded-full bg-red-100 text-red-700 ring-1 ring-red-200 px-2.5 py-0.5 text-xs">
                    Will cancel at period end
                  </span>
                {% else %}
                  <span class="inline-flex items-center rounded-full bg-emerald-100 text-emerald-800 ring-1 ring-emerald-200 px-2.5 py-0.5 text-xs">
                    Renews
                  </span>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- Actions (bottom-left on mobile, align right on md+) -->
          <div class="mt-3 flex flex-wrap gap-2 md:justify-end">
            {% if en.status == 'active' or en.status == 'trialing' %}
              {% if not en.cancel_at_period_end %}
                <form method="post" action="{% url 'healthplans:staff_enrollment_cancel' en.id %}">
                  {% csrf_token %}
                  <button class="rounded-full px-3 py-1.5 text-xs font-medium bg-red-600 text-white shadow hover:bg-red-700">
                    Cancel at period end
                  </button>
                </form>
              {% else %}
                <form method="post" action="{% url 'healthplans:staff_enrollment_resume' en.id %}">
                  {% csrf_token %}
                  <button class="rounded-full px-3 py-1.5 text-xs font-medium bg-emerald-700 text-white shadow hover:bg-emerald-800">
                    Resume
                  </button>
                </form>
              {% endif %}
            {% else %}
              <button class="rounded-full px-3 py-1.5 text-xs bg-gray-100 text-gray-600 cursor-not-allowed" disabled>
                No actions
              </button>
            {% endif %}
          </div>
        </li>
      {% endfor %}
    </ul>

    {% if enrollments_has_more %}
      <div class="text-right mt-3">
        <a href="?tab=subscribers&page={{ next_page }}" class="inline-block rounded-full px-4 py-2 text-sm font-medium ring-1 ring-emerald-900/10 bg-white/70 text-emerald-800 hover:bg-white">
          Load more
        </a>
      </div>
    {% endif %}
  {% else %}
    <div class="rounded-[28px] ring-1 ring-emerald-900/10 bg-emerald-50/70 p-6 text-emerald-900/70">No subscribers found.</div>
  {% endif %}
</section>

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function(){
  const tabs = Array.from(document.querySelectorAll('.tab-btn'));
  const panels = {
    'panel-plans': document.getElementById('panel-plans'),
    'panel-subscribers': document.getElementById('panel-subscribers')
  };

  function selectTab(targetId){
    tabs.forEach(btn => {
      const active = btn.dataset.target === targetId;
      btn.setAttribute('aria-selected', active ? 'true' : 'false');
    });
    Object.entries(panels).forEach(([id, el]) => {
      if (!el) return;
      el.classList.toggle('hidden', id !== targetId);
    });

    if (history.replaceState) {
      const url = new URL(window.location);
      url.searchParams.set('tab', targetId === 'panel-subscribers' ? 'subscribers' : 'plans');
      history.replaceState(null, '', url);
    }
  }

  tabs.forEach(btn => {
    btn.addEventListener('click', () => selectTab(btn.dataset.target));
  });

  const params = new URLSearchParams(window.location.search);
  const tabParam = params.get('tab');
  const hash = (window.location.hash || '').replace('#', '');
  if (tabParam === 'subscribers' || hash === 'subscribers') {
    selectTab('panel-subscribers');
  } else {
    selectTab('panel-plans');
  }
})();
</script>
{% endblock %}
