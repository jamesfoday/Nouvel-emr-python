{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="mx-auto w-full max-w-3xl p-4 sm:p-6">
  <div class="rounded-2xl bg-white ring-1 ring-black/5 overflow-hidden">
    <div class="flex items-center justify-between border-b px-4 sm:px-6 py-3">
      <div class="flex items-center gap-3">
        <a href="{% url 'portal_ui:home' %}#p-msgs" class="md:hidden inline-flex items-center text-sm text-gray-600 hover:text-gray-900">
          ← Back
        </a>
        <div class="h-9 w-9 rounded-full overflow-hidden bg-gray-200 grid place-items-center text-sm font-semibold text-gray-700">
          {% with nm=clinician.get_full_name|default:clinician.username %}
            {% if clinician.avatar %}
              <img src="{{ clinician.avatar.url }}" class="h-full w-full object-cover" alt="">
            {% elif clinician.profile and clinician.profile.avatar %}
              <img src="{{ clinician.profile.avatar.url }}" class="h-full w-full object-cover" alt="">
            {% else %}
              <span>{{ nm|slice:":1"|upper }}</span>
            {% endif %}
          {% endwith %}
        </div>
        <div class="min-w-0">
          <div class="font-semibold truncate">Dr {{ clinician.get_full_name|default:clinician.username }}</div>
          {% if clinician.specialty %}<div class="text-xs text-gray-500 truncate">{{ clinician.specialty }}</div>{% endif %}
        </div>
      </div>
    </div>

    <div id="p-thread" class="max-h-[70vh] overflow-y-auto p-4 sm:p-6">
      {% include "portal/partials/_thread.html" with msgs=msgs clinician=clinician admin_preview=admin_preview %}
    </div>

    <div class="border-t px-4 sm:px-6 py-3">
      <form id="p-send-form"
            hx-post="{% url 'portal_ui:messages_send' %}"
            hx-target="#p-thread"
            hx-swap="beforeend">
        {% csrf_token %}
        <input type="hidden" name="clinician_id" id="p-cid" value="{{ clinician.pk }}">
        <div class="flex gap-2">
          <input id="p-body" name="body" type="text"
                 class="flex-1 rounded-xl border px-4 py-2 text-sm"
                 placeholder="{% if admin_preview %}Admin preview – sending disabled{% else %}Type your message…{% endif %}"
                 {% if admin_preview %}disabled{% endif %}>
          <button class="rounded-xl bg-emerald-600 px-4 py-2 text-white font-medium disabled:opacity-50"
                  {% if admin_preview %}disabled{% endif %}>
            Send
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Focus composer on page load
  (function () {
    const input = document.getElementById('p-body');
    if (input && !input.hasAttribute('disabled')) {
      setTimeout(() => input.focus(), 50);
    }
  })();

  // Guard submit
  document.getElementById('p-send-form')?.addEventListener('submit', function (e) {
    const body = (document.getElementById('p-body').value || '').trim();
    if (!body) { e.preventDefault(); }
  });

  // Keep scroll at bottom when a new bubble arrives
  document.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.target.id !== 'p-thread') return;
    const t = document.getElementById('p-thread');
    t.scrollTop = t.scrollHeight;
  });
</script>
{% endblock %}
