{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="mx-auto mt-6 w-full max-w-3xl px-3 sm:px-6">
  <div class="rounded-2xl bg-[#EAF5ED] p-1">
    <div class="rounded-2xl bg-white p-4 sm:p-6 shadow">
      <h1 class="text-xl font-semibold mb-6">My Profile</h1>

      {# Admin preview banner (impersonation) #}
      {% if admin_preview %}
        <div class="mb-4 rounded-md border border-amber-200 bg-amber-50 px-3 py-2 text-amber-800 text-sm">
          Admin preview â€” editing is disabled.
          <a href="{% url 'portal_ui:dashboard_stop_impersonate' %}" class="underline">Stop preview</a>
          to enable editing.
        </div>
      {% endif %}

      {# Flash messages #}
      {% if messages %}
        <div class="space-y-2 mb-4">
          {% for m in messages %}
            <div class="rounded-md px-3 py-2 text-sm
                        {% if m.tags == 'error' %}bg-red-50 text-red-700 border border-red-200
                        {% elif m.tags == 'success' %}bg-emerald-50 text-emerald-700 border border-emerald-200
                        {% else %}bg-gray-50 text-gray-700 border border-gray-200{% endif %}">
              {{ m }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      <form action="{% url 'portal_ui:profile_update' %}"
            method="post"
            enctype="multipart/form-data"
            class="space-y-6">
        {% csrf_token %}

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <!-- Avatar -->
          <div class="md:col-span-1">
            <label for="avatar" class="block text-gray-700 font-semibold mb-2">Avatar</label>

            <div class="text-center">
              <img
                id="avatar-preview"
                src="{% if patient and patient.avatar %}{{ patient.avatar.url }}{% elif patient and patient.photo %}{{ patient.photo.url }}{% else %}{% static 'img/avatar-doc.png' %}{% endif %}"
                alt="avatar"
                class="mx-auto h-20 w-20 rounded-full object-cover ring-1 ring-gray-200"
              />

              <input id="avatar" name="avatar" type="file" accept="image/*"
                     class="sr-only" {% if admin_preview %}disabled{% endif %}>

              <label for="avatar"
                     class="mt-2 inline-flex cursor-pointer items-center justify-center text-sm font-medium
                            {% if admin_preview %}text-gray-400 cursor-not-allowed{% else %}text-emerald-700 hover:text-emerald-800{% endif %}">
                Edit
              </label>

              <p class="mt-1 text-[11px] text-gray-400">PNG/JPG, up to 5MB</p>
            </div>
          </div>

          <!-- Contact & address -->
          <div class="md:col-span-2 grid grid-cols-1 sm:grid-cols-2 gap-4">

            <div class="sm:col-span-2">
              <label for="phone" class="block text-gray-700 font-semibold mb-1">Phone</label>
              <input id="phone" name="phone" autocomplete="tel"
                     value="{{ patient.phone|default:'' }}"
                     {% if admin_preview %}disabled{% endif %}
                     class="w-full rounded-md border px-3 py-2">
            </div>

            <div class="sm:col-span-2">
              <label for="address_line" class="block text-gray-700 font-semibold mb-1">Address line</label>
              <input id="address_line" name="address_line" autocomplete="address-line1"
                     value="{{ patient.address_line|default:'' }}"
                     {% if admin_preview %}disabled{% endif %}
                     class="w-full rounded-md border px-3 py-2">
            </div>

            <div>
              <label for="city" class="block text-gray-700 font-semibold mb-1">City</label>
              <input id="city" name="city" autocomplete="address-level2"
                     value="{{ patient.city|default:'' }}"
                     {% if admin_preview %}disabled{% endif %}
                     class="w-full rounded-md border px-3 py-2">
            </div>

            <div>
              <label for="region" class="block text-gray-700 font-semibold mb-1">Region / State</label>
              <input id="region" name="region" autocomplete="address-level1"
                     value="{{ patient.region|default:'' }}"
                     {% if admin_preview %}disabled{% endif %}
                     class="w-full rounded-md border px-3 py-2">
            </div>

            <div>
              <label for="postal_code" class="block text-gray-700 font-semibold mb-1">Postal code</label>
              <input id="postal_code" name="postal_code" autocomplete="postal-code"
                     value="{{ patient.postal_code|default:'' }}"
                     {% if admin_preview %}disabled{% endif %}
                     class="w-full rounded-md border px-3 py-2">
            </div>

            <div>
              <label for="country" class="block text-gray-700 font-semibold mb-1">Country</label>
              <input id="country" name="country" autocomplete="country-name"
                     value="{{ patient.country|default:'' }}"
                     {% if admin_preview %}disabled{% endif %}
                     class="w-full rounded-md border px-3 py-2">
            </div>
          </div>
        </div>

        <div class="mt-6 flex flex-col-reverse gap-3 sm:flex-row sm:justify-end">
          <a href="{% url 'portal_ui:home' %}"
             class="w-full sm:w-auto rounded-md bg-red-600 px-6 py-2 font-semibold text-white text-center hover:bg-red-700">
            Cancel
          </a>
          <button type="submit"
                  {% if admin_preview %}disabled{% endif %}
                  class="w-full sm:w-auto rounded-md bg-emerald-600 px-6 py-2 font-semibold text-white
                         hover:bg-emerald-700 disabled:opacity-50">
            Save
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  // Live avatar preview (no-op when disabled)
  (function () {
    const input = document.getElementById('avatar');
    const img   = document.getElementById('avatar-preview');
    if (!input || !img || input.disabled) return;
    input.addEventListener('change', () => {
      const f = input.files && input.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = e => { img.src = e.target.result; };
      reader.readAsDataURL(f);
    });
  })();
</script>
{% endblock %}
