{% extends "base.html" %}
{% load static %}

{# Add a Logout button specifically on the patient dashboard app bar #}
{% block appbar_right %}
  <form method="post" action="{% url 'logout' %}" class="m-0">
    {% csrf_token %}
    <button
      type="submit"
      class="inline-flex items-center gap-2 rounded-xl bg-rose-600 hover:bg-rose-700 text-white px-3 md:px-4 py-1.5 md:py-2 text-sm font-medium shadow-sm"
      title="Sign out"
    >
      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a2 2 0 01-2 2H7a2 2 0 01-2-2V7a2 2 0 012-2h4a2 2 0 012 2v1"/>
      </svg>
      <span class="hidden sm:inline">Logout</span>
      <span class="sm:hidden">Sign out</span>
    </button>
  </form>
{% endblock %}

{% block content %}

<div class="p-6 space-y-6 pb-28 md:pb-6">
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    {# Profile card #}
    <div class="bg-teal-500 text-white rounded-3xl p-8 lg:p-10 flex flex-col items-center text-center shadow-sm">
      <div class="w-44 h-44 rounded-full bg-white grid place-items-center">
        {% if patient and patient.avatar %}
          <img src="{{ patient.avatar.url }}" alt="Avatar" class="w-40 h-40 object-cover rounded-full">
        {% elif patient and patient.photo %}
          <img src="{{ patient.photo.url }}" alt="Avatar" class="w-40 h-40 object-cover rounded-full">
        {% else %}
          <img src="{% static 'img/avatar-doc.png' %}" alt="Avatar" class="w-40 h-40 object-contain opacity-95">
        {% endif %}
      </div>

      <a href="{% url 'portal_ui:profile' %}"
         class="mt-3 inline-block text-emerald-900/90 bg-white/90 hover:bg-white px-4 py-1.5 rounded-full text-sm font-medium">
        edit profile
      </a>

      <div class="text-4xl font-extrabold tracking-tight mt-6">
        {{ patient.given_name|default:request.user.get_username|title }}
      </div>
    </div>

    {# Consultation #}
    <section class="rounded-2xl bg-white p-4 ring-1 ring-black/5 md:col-span-2">
      <div class="mb-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div class="font-semibold">Consultation</div>

        <div class="flex w-full flex-wrap items-center gap-2 sm:w-auto">
          <div class="relative order-1 w-full sm:order-none sm:w-64">
            <input
              id="p-appt-q"
              type="search"
              placeholder="Search‚Ä¶"
              class="w-full rounded-full border border-gray-300 px-4 py-2 pr-9 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
              hx-get="{% url 'portal_ui:appts_panel' %}"
              hx-target="#p-appts"
              hx-trigger="input changed delay:350ms, search"
              hx-include="#p-appt-q"
              name="q"
            />
            <svg class="pointer-events-none absolute right-3 top-2.5 h-4 w-4 text-gray-400" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 21l-4.3-4.3m1.3-5.2a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>

          <a href="#"
             class="shrink-0 inline-flex items-center gap-1 rounded-full bg-emerald-600 px-3 py-2 text-sm font-semibold text-white hover:bg-emerald-700">
            Book
            <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M12 5v14m-7-7h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
            </svg>
          </a>

           <a href="{% url 'portal_ui:appts_list' %}"
     class="inline-flex items-center rounded-xl bg-gray-100 hover:bg-gray-200 px-3 py-1.5 text-sm font-semibold text-gray-700">
    See all
  </a>
        </div>
      </div>

      <div id="p-appts"
           class="min-h-[84px]"
           hx-get="{% url 'portal_ui:appts_panel' %}"
           hx-trigger="load"
           hx-swap="innerHTML">
        <div class="text-sm text-gray-400">Loading‚Ä¶</div>
      </div>
    </section>

    {# Tests #}
    <section class="rounded-2xl bg-white p-4 ring-1 ring-black/5">
      <div class="mb-3 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
        <div class="font-semibold">Test</div>

        <div class="flex w-full flex-wrap items-center gap-2 sm:w-auto">
          <div class="relative order-1 w-full sm:order-none sm:w-64">
            <input
              id="p-tests-q"
              type="search"
              placeholder="Search tests (title)"
              class="w-full rounded-full border border-gray-300 px-4 py-2 pr-9 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-400"
              hx-get="{% url 'portal_ui:tests_panel' %}"
              hx-target="#p-tests"
              hx-trigger="input changed delay:350ms, search"
              hx-include="#p-tests-q"
              name="q"
            />
            <svg class="pointer-events-none absolute right-3 top-2.5 h-4 w-4 text-gray-400" viewBox="0 0 24 24" fill="none" aria-hidden="true">
              <path d="M21 21l-4.3-4.3m1.3-5.2a6.5 6.5 0 11-13 0 6.5 6.5 0 0113 0z" stroke="currentColor" stroke-width="2"/>
            </svg>
          </div>

          <a href="#"
             class="shrink-0 inline-flex items-center rounded-full bg-gray-100 px-3 py-2 text-sm font-semibold text-gray-800 hover:bg-gray-200">
            See all
          </a>
        </div>
      </div>

      <div id="p-tests"
           class="min-h-[84px]"
           hx-get="{% url 'portal_ui:tests_panel' %}"
           hx-trigger="load"
           hx-swap="innerHTML">
        <div class="text-sm text-gray-400">Loading‚Ä¶</div>
      </div>
    </section>

    {# Desktop quick actions (optional) #}
    <div class="bg-white rounded-2xl p-4 ring-1 ring-black/5 space-y-4 hidden md:block">
      <div class="grid grid-cols-2 gap-4">
        <a href="#p-appts" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-gray-50 hover:bg-gray-100">
          <div class="shortcut-circle relative">
            <img src="{% static 'img/shortcuts/appointments.svg' %}" alt="Appointments" class="w-8 h-8"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';" />
            <span class="hidden absolute inset-0 place-items-center text-2xl">üóìÔ∏è</span>
          </div>
          <div class="text-base font-semibold">Appointments</div>
        </a>

        <a href="#p-tests" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-gray-50 hover:bg-gray-100">
          <div class="shortcut-circle relative">
            <img src="{% static 'img/shortcuts/tests.svg' %}" alt="Tests" class="w-8 h-8"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';" />
            <span class="hidden absolute inset-0 place-items-center text-2xl">üß™</span>
          </div>
          <div class="text-base font-semibold">Tests</div>
        </a>

        <a href="#p-msgs" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-gray-50 hover:bg-gray-100">
          <div class="shortcut-circle relative">
            <img src="{% static 'img/shortcuts/prescription.svg' %}" alt="Prescription" class="w-8 h-8"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';" />
            <span class="hidden absolute inset-0 place-items-center text-2xl">üí¨</span>
          </div>
          <div class="text-base font-semibold">Prescription</div>
        </a>

        <a href="#p-msgs" class="flex flex-col items-center justify-center gap-2 p-4 rounded-xl bg-gray-50 hover:bg-gray-100">
          <div class="shortcut-circle relative">
            <img src="{% static 'img/shortcuts/messages.svg' %}" alt="Messages" class="w-8 h-8"
                 onerror="this.style.display='none'; this.nextElementSibling.style.display='grid';" />
            <span class="hidden absolute inset-0 place-items-center text-2xl">üí¨</span>
          </div>
          <div class="text-base font-semibold">Messages</div>
        </a>
      </div>
    </div>

    {# Direct Messages #}
    <div class="lg:col-span-3 bg-white rounded-2xl p-0 ring-1 ring-black/5">
      <div class="flex border-b">
        <button class="px-4 py-2 text-gray-500"
                hx-get="{% url 'portal_ui:messages_panel' %}#dm"
                hx-target="#p-msgs"
                hx-swap="innerHTML">Direct Message</button>
      </div>
      <div id="p-msgs" class="p-4"
           hx-get="{% url 'portal_ui:messages_panel' %}"
           hx-trigger="load"
           hx-swap="innerHTML">
        <div class="text-gray-400 text-sm p-2">Loading‚Ä¶</div>
      </div>
    </div>

  </div>
</div>

{# ------------------------------------------------------------------------- #}
{# Mobile dock (mobile/tablet only). Uses primary_shortcuts / more_shortcuts #}
{# If view doesn't provide them, fall back to sensible defaults.             #}
{# ------------------------------------------------------------------------- #}

<div class="mobile-dock md:hidden">
  <div class="mobile-dock__row">

    {# Left button (fallback: Tests) #}
    <a href="{{ primary_shortcuts.0.href|default:'#p-tests' }}" class="dock-btn">
      <span class="dock-btn__circle">
        <img src="{% static 'img/shortcuts/' %}{{ primary_shortcuts.0.icon|default:'tests.svg' }}" alt=""
             onerror="this.remove()">
      </span>
      <span class="dock-btn__label">{{ primary_shortcuts.0.label|default:"Tests" }}</span>
    </a>

    {# Center: opens the off-canvas menu #}
    <button type="button" class="dock-btn dock-btn--primary" id="dock-open">
      <span class="dock-btn__circle">
        <svg viewBox="0 0 24 24" class="w-8 h-8" fill="currentColor" aria-hidden="true">
          <circle cx="8" cy="8" r="3"></circle>
          <circle cx="16" cy="8" r="3"></circle>
          <circle cx="8" cy="16" r="3"></circle>
          <circle cx="16" cy="16" r="3"></circle>
        </svg>
      </span>
      <span class="dock-btn__label">More</span>
    </button>

    {# Right button (fallback: Prescription) #}
    <a href="{{ primary_shortcuts.1.href|default:'#p-msgs' }}" class="dock-btn">
      <span class="dock-btn__circle">
        <img src="{% static 'img/shortcuts/' %}{{ primary_shortcuts.1.icon|default:'prescription.svg' }}" alt=""
             onerror="this.remove()">
      </span>
      <span class="dock-btn__label">{{ primary_shortcuts.1.label|default:"Prescription" }}</span>
    </a>
  </div>
</div>

<div id="offcanvas" class="offcanvas md:hidden" aria-hidden="true">
  <div class="offcanvas__mask" id="oc-mask"></div>
  <div class="offcanvas__panel" role="dialog" aria-modal="true" aria-label="Quick actions">
    <div class="flex items-center justify-between mb-3">
      <div class="font-semibold">Menu</div>
      <button type="button" id="dock-close" class="btn">‚úï</button>
    </div>

    <div class="offcanvas__list">
      {# If more_shortcuts is present, use it; else show Appointments + Messages #}
      {% if more_shortcuts %}
        {% for s in more_shortcuts %}
          <a href="{{ s.href }}" class="offcanvas__item">
            <span class="offcanvas__circle {% if s.accent == 'red' %}bg-red-500 text-white border-transparent{% endif %}">
              <img src="{% static 'img/shortcuts/' %}{{ s.icon }}" alt="" onerror="this.remove()">
            </span>
            <span class="offcanvas__label">{{ s.label }}</span>
          </a>
        {% endfor %}
      {% else %}
        <a href="#p-appts" class="offcanvas__item">
          <span class="offcanvas__circle">
            <img src="{% static 'img/shortcuts/appointments.svg' %}" alt="" onerror="this.remove()">
          </span>
          <span class="offcanvas__label">Appointments</span>
        </a>
        <a href="#p-msgs" class="offcanvas__item">
          <span class="offcanvas__circle">
            <img src="{% static 'img/shortcuts/messages.svg' %}" alt="" onerror="this.remove()">
          </span>
          <span class="offcanvas__label">Messages</span>
        </a>
      {% endif %}
    </div>
  </div>
</div>

<script>
  // Mobile off-canvas controls
  const ocRoot   = document.getElementById('offcanvas');
  const ocMask   = document.getElementById('oc-mask');
  const openBtn  = document.getElementById('dock-open');
  const closeBtn = document.getElementById('dock-close');

  function openOC(){
    ocRoot.classList.add('is-open');
    document.body.style.overflow = 'hidden';
  }
  function closeOC(){
    ocRoot.classList.remove('is-open');
    document.body.style.overflow = '';
  }

  openBtn?.addEventListener('click', openOC);
  closeBtn?.addEventListener('click', closeOC);
  ocMask?.addEventListener('click', closeOC);
  document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeOC(); });
</script>

{% endblock %}
